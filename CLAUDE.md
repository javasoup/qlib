# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Qlib is Microsoft's open-source AI-oriented quantitative investment platform. It covers the full ML pipeline for quantitative trading: data processing, feature engineering, model training, backtesting, and portfolio optimization. Published on PyPI as `pyqlib`.

## Build & Install

```bash
# Cython extensions must be compiled first (rolling.pyx, expanding.pyx in qlib/data/_libs/)
make prerequisite          # Compile Cython extensions
make install               # prerequisite + pip install -e .
make dev                   # prerequisite + install all optional deps

# Individual optional dependency groups
pip install -e ".[dev]"    # pytest, statsmodels
pip install -e ".[lint]"   # black, pylint, mypy, flake8, nbqa
pip install -e ".[rl]"     # torch, tianshou (Linux only)
pip install -e ".[docs]"   # sphinx
```

## Lint & Format

```bash
make lint                  # Run all linters (black + pylint + flake8 + mypy + nbqa)
make black                 # black . -l 120 --check --diff --exclude qlib/_version.py
make pylint                # pylint on qlib/ and scripts/ (many rules disabled, see Makefile)
make flake8                # flake8 --ignore=E501,F541,E266,E402,W503,E731,E203
make mypy                  # mypy qlib
```

- **Line length**: 120 characters (Black enforced)
- **Formatter**: Black (pre-commit hook configured)
- **Docstrings**: Numpydoc style

## Testing

```bash
pytest tests/                          # Run all tests
pytest tests/ -m "not slow"            # Skip slow tests
pytest tests/backtest/                 # Run a test subdirectory
pytest tests/ops/test_elem_operator.py # Run a single test file
pytest tests/ops/test_elem_operator.py::TestClass::test_method  # Single test
```

- Config in `tests/pytest.ini`; marker `@pytest.mark.slow` for slow tests
- RL tests (`tests/rl/`) are skipped on non-Linux platforms via `tests/conftest.py`

## Commit Convention

Conventional commits enforced via commitlint (max 100 char header):
- Types: `build`, `chore`, `ci`, `docs`, `feat`, `fix`, `perf`, `refactor`, `revert`, `style`, `test`

## Architecture

### Core Modules (`qlib/`)

- **`data/`** — Data layer with expression engine for feature engineering. Uses `.bin` format storage. Cython-optimized rolling/expanding operations in `data/_libs/`. Supports caching via Redis/MongoDB/local backends and Point-in-Time databases.
- **`model/`** — Base model interfaces and trainers. `qlib/model/base.py` defines the `Model` base class.
- **`workflow/`** — Experiment management built on MLflow. Task execution, recorder system for tracking runs. Supports offline and online (server) modes.
- **`backtest/`** — Portfolio backtesting engine with order execution simulation, account/position management, and nested execution framework for complex multi-level strategies.
- **`strategy/`** — Trading strategy implementations and portfolio optimization (uses cvxpy).
- **`rl/`** — Reinforcement learning module for order execution (Linux only, depends on torch + tianshou).
- **`contrib/`** — Pre-built models (LightGBM, LSTM, GAT, Transformer, TabNet, etc.), datasets (Alpha158, Alpha360), and evaluation utilities.
- **`cli/`** — CLI tools. `qrun` command executes workflows from YAML config files.
- **`config.py`** — Central configuration management using pydantic-settings.
- **`utils/`** — Shared utilities including serialization, time handling, and object construction.

### Key Patterns

- **Initialization**: All Qlib usage starts with `qlib.init()` which configures data providers, logging, and mounts.
- **Config-driven workflows**: The `qrun` CLI reads YAML files that define the full pipeline (data → model → strategy → backtest). See `examples/benchmarks/` for ~27 model benchmark configs.
- **Expression engine**: Features are defined as string expressions (e.g., `"Ref($close, -1) / $close"`) parsed and evaluated by `qlib/data/ops.py`.
- **Loose coupling**: Each module (data, model, backtest, strategy) can be used independently.
- **Version**: Auto-generated by setuptools-scm into `qlib/_version.py` — do not edit this file.
